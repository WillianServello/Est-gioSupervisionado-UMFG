@using cafeservellocontroler.Models.ViewModels
@using System.Globalization;
@model VendaViewModel



<form id="formVendas" asp-controller="Venda" asp-action="Criar" method="post">
    <div class="div-Criar reponsivo">
    <div class="row mb-3">
        <div class="col-12">
            <label class="">Revendedor*</label>
                <select asp-for="RevendedorId" class="form-select form-control" required>
                <option value="">Selecione o revendedor</option>
                @foreach (var r in Model.Revendedores)
                {
                    <option value="@r.Id">@r.Nome</option>
                }
            </select>
            <span asp-validation-for="RevendedorId" class="text-danger"></span>
        </div>
    </div>

    <hr />

    <h4>Itens da Venda</h4>
    <div id="itensContainer" class="criacao-venda">

        @for (int i = 0; i < Model.Itens.Count; i++)
        {
            <div class="row item-row mb-3 border-bottom pb-3" data-index="@i">

                <div class="col-6">
                    <label class="">Produto*</label>

                    <select asp-for="Itens[i].ProdutoId"
                            class="form-select select-produto form-control"
                            onchange="atualizarValor(this)"
                            required>

                        <option value="">Selecione o produto</option>

                        @foreach (var p in Model.Produtos)
                        {
                            <option value="@p.Id"
                                    data-valor="@p.Preco.ToString("F2", CultureInfo.InvariantCulture)"
                                    data-estoque="@p.Estoque">
                                @p.Nome
                            </option>
                        }
                    </select>

                    <!-- Exibe estoque atual -->
                    <div class="text-muted estoque-info">Estoque: --</div>

                    <span asp-validation-for="Itens[i].ProdutoId" class="text-danger"></span>
                </div>

                <div class="col-3">
                    <label class="">Quantidade*</label>
                    <input type="number"
                           asp-for="Itens[i].Quantidade"
                           class="form-control input-quantidade"
                           oninput="atualizarQuantidade(this)"
                           min="1"
                           value="1"
                           required />

                    <span asp-validation-for="Itens[i].Quantidade" class="text-danger"></span>
                </div>

                <div class="col-3 text-end">
                    <label class="form-label">Valor Unitário</label>

                    <div class="fw-bold">
                        R$ <span class="valor-unitario-display">0.00</span>
                    </div>

                    <input type="hidden"
                           asp-for="Itens[i].Valor"
                           class="input-valor-hidden"
                           value="0" />

                    <a href="#"
                       class="text-danger remove-item"
                       style="font-size: 0.8em; @(i == 0 ? "display:none;" : "")"
                       onclick="removerItem(this, event)">
                        Remover
                    </a>
                </div>

                
                <div class="col-12 mt-2 text-end">
                    <div>
                        <label class="form-label me-2">Total Item:</label>
                        <span class="fw-bold fs-5 text-primary">
                            R$ <span class="total-item-display">0.00</span>
                        </span>
                        </div>
                </div>

            </div>
        }
    </div>

    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="adicionarItem()">+ Adicionar Produto</button>

    <hr />

    <h5 class="mt-3">Total da venda: R$ <span id="totalGeral" class="text-success fw-bold">0.00</span></h5>

    
    </div>
    <div class=" d-flex justify-content-end   ">

        <button type="submit" class="btn btn-primary mt-3 button-submit-close " style="margin-right: 15px">
            <i class="fa-regular fa-floppy-disk fa-lg"></i>
            Adicionar


        </button>

        <a role="button" class="btn btn-outline-danger mt-3 button-submit-close" data-bs-dismiss="modal">
            <i class="fa-solid fa-eject fa-lg"></i>
            Cancelar
        </a>
    </div>


</form>


<!-- =========================== -->
<!--  JAVASCRIPT COMPLETO       -->
<!-- =========================== -->



    <script>

    let nextItemIndex = @Model.Itens.Count;

    // ========================
    // REINDEXAR DEPOIS DE REMOVER
    // ========================
    function reindexarItens() {
        let index = 0;

        document.querySelectorAll('.item-row').forEach(row => {

            row.dataset.index = index;

            row.querySelector('.select-produto').name = `Itens[${index}].ProdutoId`;
            row.querySelector('.input-quantidade').name = `Itens[${index}].Quantidade`;
            row.querySelector('.input-valor-hidden').name = `Itens[${index}].Valor`;

            index++;
        });

        nextItemIndex = index;
    }

    // ========================
    // CÁLCULO DOS ITENS
    // ========================
    function calcularItem(itemRow) {
        const selectProduto = itemRow.querySelector('.select-produto');
        const inputQuantidade = itemRow.querySelector('.input-quantidade');
        const inputValorHidden = itemRow.querySelector('.input-valor-hidden');
        const spanValorDisplay = itemRow.querySelector('.valor-unitario-display');
        const spanTotalDisplay = itemRow.querySelector('.total-item-display');

        const selectedOption = selectProduto.options[selectProduto.selectedIndex];

        const valorUnitario = parseFloat(selectedOption?.getAttribute('data-valor')) || 0;
        const quantidade = parseInt(inputQuantidade.value) || 0;

        inputValorHidden.value = valorUnitario.toFixed(2);
        spanValorDisplay.innerText = valorUnitario.toFixed(2);

        const totalItem = valorUnitario * quantidade;
        spanTotalDisplay.innerText = totalItem.toFixed(2);

        atualizarTotalGeral();
    }

    function atualizarValor(select) {
        const itemRow = select.closest('.item-row');
        const selectedOption = select.options[select.selectedIndex];

        const estoque = parseInt(selectedOption?.getAttribute('data-estoque')) || 0;
        const inputQuantidade = itemRow.querySelector('.input-quantidade');

        itemRow.querySelector('.estoque-info').innerText = "Estoque: " + estoque;
        inputQuantidade.max = estoque;

        if (parseInt(inputQuantidade.value) > estoque)
            inputQuantidade.value = estoque;

        calcularItem(itemRow);
        bloquearProdutosRepetidos();
    }

    function atualizarQuantidade(input) {
        const max = parseInt(input.max);
        if (parseInt(input.value) > max) {
            input.value = max;
        }
        const itemRow = input.closest('.item-row');
        calcularItem(itemRow);
    }

    function atualizarTotalGeral() {
        let soma = 0;

        document.querySelectorAll('.total-item-display').forEach(span => {
            soma += parseFloat(span.innerText) || 0;
        });

        document.getElementById('totalGeral').innerText = soma.toFixed(2);
    }

    // ========================
    // BLOQUEAR PRODUTOS REPETIDOS
    // ========================
        function bloquearProdutosRepetidos(container = document.getElementById('itensContainer')) {

        const selects = container.querySelectorAll('.select-produto');
        const usados = [...selects].map(s => s.value).filter(v => v !== "");

        selects.forEach(s => {
            s.querySelectorAll('option').forEach(o => {
                if (usados.includes(o.value) && o.value !== s.value)
                    o.disabled = true;
                else
                    o.disabled = false;
            });
        });

    }

    // ========================
    // ADICIONAR ITEM
    // ========================
    function adicionarItem() {
        const container = document.getElementById('itensContainer');
        const index = nextItemIndex;

        const html = `
            <div class="row item-row mb-3 border-bottom pb-3" data-index="${index}">
                <div class="col-6">
                    <label class="form-label">Produto</label>
                    <select name="Itens[${index}].ProdutoId"
                            class="form-select select-produto form-control"
                            onchange="atualizarValor(this)"
                            required>
                        <option value="">Selecione o produto</option>
                        @foreach (var p in Model.Produtos)
                        {
                                <option value="@p.Id"
                                        data-valor="@p.Preco"
                                        data-estoque="@p.Estoque">
                                    @p.Nome
                                </option>
                        }
                    </select>
                    <div class="text-muted estoque-info">Estoque: --</div>
                </div>

                <div class="col-3">
                    <label class="form-label">Quantidade</label>
                    <input type="number"
                           name="Itens[${index}].Quantidade"
                           class="form-control input-quantidade"
                           oninput="atualizarQuantidade(this)"
                           min="1"
                           value="1"
                           required />
                </div>

                <div class="col-3 text-end">
                    <label class="form-label">Valor Unitário</label>
                    <div class="fw-bold">
                        R$ <span class="valor-unitario-display">0.00</span>
                    </div>
                    <input type="hidden"
                           name="Itens[${index}].Valor"
                           class="input-valor-hidden"
                           value="0" />
                    <a href="#"
                       class="text-danger remove-item"
                       onclick="removerItem(this, event)"
                       style="font-size: 0.8em;">
                       Remover
                    </a>
                </div>

                <div class="col-12 mt-2 text-end">
                    <label class="form-label me-2">Total Item:</label>
                    <span class="fw-bold fs-5 text-primary">
                        R$ <span class="total-item-display">0.00</span>
                    </span>
                </div>
            </div>
        `;

        container.insertAdjacentHTML("beforeend", html);

        nextItemIndex++;
        bloquearProdutosRepetidos();
    }

    // ========================
    // REMOVER ITEM
    // ========================
    function removerItem(link, event) {
        event.preventDefault();

        link.closest('.item-row').remove();

        reindexarItens();
        atualizarTotalGeral();
        bloquearProdutosRepetidos();
    }

    // ========================
    // INICIALIZAÇÃO
    // ========================
        document.addEventListener('DOMContentLoaded', () => {
        const container = document.querySelector(".criacao-venda");
        container.querySelectorAll('.item-row').forEach(row => calcularItem(row));
        bloquearProdutosRepetidos(container);
    });

</script>
