
@using cafeservellocontroler.Models.ViewModels
@using System.Globalization
@model VendaViewModel

<form id="formVendas" asp-controller="Venda" asp-action="Atualizar" method="post">

    <input type="hidden" asp-for="Id" />

    <div class="row mb-3">
        <div class="col-12">
            <label class="form-label">Revendedor</label>
            <select asp-for="RevendedorId" class="form-select" required>
                <option value="">Selecione o revendedor</option>
                @foreach (var r in Model.Revendedores)
                {
                    <option value="@r.Id">@r.Nome</option>
                }
            </select>
            <span asp-validation-for="RevendedorId" class="text-danger"></span>
        </div>
    </div>

    <hr />

    <h4>Itens da Venda</h4>

    <div id="itensContainer">

        @for (int i = 0; i < Model.Itens.Count; i++)
        {
            <div class="row item-row mb-3 border-bottom pb-3" data-index="@i">

                <div class="col-6">
                    <label class="form-label">Produto</label>
                    <select asp-for="Itens[i].ProdutoId" class="form-select select-produto"
                            onchange="atualizarValor(this)" required>
                        <option value="">Selecione o produto</option>

                        @foreach (var p in Model.Produtos)
                        {
                            <option value="@p.Id"
                                    selected="@(p.Id == Model.Itens[i].ProdutoId)"
                                    data-valor="@p.Preco.ToString("F2", CultureInfo.InvariantCulture)"
                                    data-estoque="@(p.Id == Model.Itens[i].ProdutoId ? Model.Itens[i].EstoqueProduto : p.Estoque)">
                                
                                @p.Nome
                            </option>
                        }

                    </select>

                    <div class="text-muted estoque-info">Estoque: --</div>

                    <span asp-validation-for="Itens[i].ProdutoId" class="text-danger"></span>
                </div>

                <div class="col-3">
                    <label class="form-label">Quantidade</label>
                    <input type="number" asp-for="Itens[i].Quantidade" class="form-control input-quantidade"
                           oninput="atualizarQuantidade(this)" min="1" required />
                    <span asp-validation-for="Itens[i].Quantidade" class="text-danger"></span>
                </div>

                <div class="col-3 text-end">
                    <label class="form-label">Valor Unitário</label>
                    <div class="fw-bold">R$ <span class="valor-unitario-display">0.00</span></div>

                    <input type="hidden" asp-for="Itens[i].Valor" class="input-valor-hidden" />

                    <a href="#" class="text-danger remove-item" style="font-size: 0.8em; @(i == 0 ? "display:none;" : "")"
                       onclick="removerItem(this, event)">
                        Remover
                    </a>
                </div>

                <div class="col-12 mt-2 text-end">
                    <label class="form-label me-2">Total Item:</label>
                    <span class="fw-bold fs-5 text-primary">
                        R$ <span class="total-item-display">0.00</span>
                    </span>
                </div>

            </div>
        }

    </div>

    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="adicionarItem()">
        + Adicionar Produto
    </button>

    <hr />

    <h5 class="mt-3">
        Total da venda: R$ <span id="totalGeral" class="text-success fw-bold">0.00</span>
    </h5>

    <button type="submit" class="btn btn-primary w-100 mt-3">Salvar Alterações</button>
    <button type="button" class="btn btn-danger w-100 mt-2" data-bs-dismiss="modal">Cancelar</button>

</form>



<script>
    let nextItemIndex = @Model.Itens.Count;

    // ==========================================
    // FUNÇÃO PARA REINDEXAR APÓS REMOVER
    // ==========================================
    function reindexarItens() {
        let index = 0;
        document.querySelectorAll('.item-row').forEach(row => {

        row.dataset.index = index;

    row.querySelector('.select-produto').name = `Itens[${index}].ProdutoId`;
    row.querySelector('.input-quantidade').name = `Itens[${index}].Quantidade`;
    row.querySelector('.input-valor-hidden').name = `Itens[${index}].Valor`;

    index++;
        });

    nextItemIndex = index;
    }

    // ==========================================
    // CÁLCULO DE VALOR DO ITEM
    // ==========================================
        // ==========================================
    function calcularItem(itemRow) {
        const selectProduto = itemRow.querySelector('.select-produto');
        const inputQuantidade = itemRow.querySelector('.input-quantidade');
        const inputValorHidden = itemRow.querySelector('.input-valor-hidden');
        const spanValor = itemRow.querySelector('.valor-unitario-display');
        const spanTotal = itemRow.querySelector('.total-item-display');

        const option = selectProduto.options[selectProduto.selectedIndex];

        // 🛑 MUDANÇA AQUI: Obtém o valor do produto (data-valor) ou o valor salvo (input hidden)
        const valorProdutoAtual = parseFloat(option?.getAttribute('data-valor')) || 0;
        const valorSalvoNoHidden = parseFloat(inputValorHidden.value) || 0;

        // Na inicialização (edição), o inputValorHidden já está preenchido pelo Razor.
        // Usamos esse valor para o cálculo e exibição inicial.
        // Se o select for trocado, atualiza-se para o valorProdutoAtual (data-valor)
        let valorUnit;
        if (selectProduto.selectedIndex > 0 && valorSalvoNoHidden > 0) {
            // Se já tem um produto selecionado E o input hidden tem o valor salvo (Edição)
            valorUnit = valorSalvoNoHidden;
        } else {
            // Se for um novo item ou o select foi trocado
            valorUnit = valorProdutoAtual;
        }

        const qtd = parseInt(inputQuantidade.value) || 0;

        // Garante que o input hidden e o display mostrem o valor que está sendo usado no cálculo.
        // Na Edição, isso fará com que o R$ 123.00 permaneça no input hidden e na tela.
        inputValorHidden.value = valorUnit.toFixed(2);
        spanValor.innerText = valorUnit.toFixed(2);

        const total = valorUnit * qtd;
        spanTotal.innerText = total.toFixed(2);

        atualizarTotalGeral();
    }

    // =============================
    // ATUALIZAÇÃO AO TROCAR PRODUTO
    // =============================
            function atualizarValor(select) {
        const row = select.closest('.item-row');
        const option = select.options[select.selectedIndex];

        const estoque = parseInt(option?.getAttribute('data-estoque')) || 0;
        const inputQtd = row.querySelector('.input-quantidade');

        // 🛑 ADICIONE ESTA LINHA: Zera o valor escondido ao trocar o produto
        // Isso garante que o cálculo use o data-valor novo em vez do valor salvo (antigo)
        row.querySelector('.input-valor-hidden').value = 0;

        row.querySelector('.estoque-info').innerText = "Estoque: " + estoque;

        inputQtd.max = estoque;

        // Você removeu o bloco que limita a quantidade aqui.
        // É uma boa prática para edição, pois mantem a quantidade original,
        // apenas limitando novos aumentos.

        calcularItem(row);
        bloquearProdutosRepetidos();
    }

    // ==============================
    // ATUALIZA QUANTIDADE
    // ==============================
    function atualizarQuantidade(input) {
        const max = parseInt(input.max);
        if (parseInt(input.value) > max)
    input.value = max;

    const row = input.closest('.item-row');
    calcularItem(row);
    }

    // ==============================
    // SOMA TOTAL DA VENDA
    // ==============================
    function atualizarTotalGeral() {
        let soma = 0;

        document.querySelectorAll('.total-item-display').forEach(t => {
        soma += parseFloat(t.innerText) || 0;
        });

    document.getElementById('totalGeral').innerText = soma.toFixed(2);
    }

    // ==============================
    // BLOQUEAR PRODUTOS DUPLICADOS
    // ==============================
            function bloquearProdutosRepetidos(container = document.getElementById('itensContainer')) {

        const selects = container.querySelectorAll('.select-produto');

        // 👉 SE NÃO TIVER NENHUM ITEM AINDA (CRIAR) → NÃO BLOQUEIA NADA
        if (selects.length <= 1) {
            selects.forEach(s => {
                s.querySelectorAll('option').forEach(o => o.disabled = false);
            });
            return;
        }

        const usados = [...selects]
            .map(s => s.value)
            .filter(v => v !== "");

        selects.forEach(s => {
            s.querySelectorAll('option').forEach(o => {
                if (usados.includes(o.value) && o.value !== s.value) {
                    o.disabled = true;
                } else {
                    o.disabled = false;
                }
            });
        });
    }

    // =================================
    // ADICIONAR NOVO ITEM (CORRIGIDO)
    // =================================
    function adicionarItem() {
        const container = document.getElementById('itensContainer');
    const index = nextItemIndex;

    const html = `
<div class="row item-row mb-3 border-bottom pb-3" data-index="${index}">

    <div class="col-6">
        <label class="form-label">Produto</label>
        <select name="Itens[${index}].ProdutoId" class="form-select select-produto"
                onchange="atualizarValor(this)" required>
            <option value="">Selecione o produto</option>
            @foreach (var p in Model.Produtos)
            {
                <option value="@p.Id" data-valor="@p.Preco" data-estoque="@p.Estoque">@p.Nome</option>
            }
        </select>
        <div class="text-muted estoque-info">Estoque: --</div>
    </div>

    <div class="col-3">
        <label class="form-label">Quantidade</label>
        <input type="number" name="Itens[${index}].Quantidade"
               class="form-control input-quantidade"
               oninput="atualizarQuantidade(this)" min="1" value="1" required />
    </div>

    <div class="col-3 text-end">
        <label class="form-label">Valor Unitário</label>
        <div class="fw-bold">
            R$ <span class="valor-unitario-display">0.00</span>
        </div>

        <input type="hidden" name="Itens[${index}].Valor"
               class="input-valor-hidden" value="0" />

        <a href="#" class="text-danger remove-item"
           onclick="removerItem(this, event)" style="font-size: 0.8em;">
            Remover
        </a>
    </div>

    <div class="col-12 mt-2 text-end">
        <label class="form-label me-2">Total Item:</label>
        <span class="fw-bold fs-5 text-primary">
            R$ <span class="total-item-display">0.00</span>
        </span>
    </div>

</div>
    `;

    container.insertAdjacentHTML("beforeend", html);
    nextItemIndex++;

    bloquearProdutosRepetidos();
    }

    // ==============================
    // REMOVER ITEM
    // ==============================
    function removerItem(link, event) {
        event.preventDefault();

    link.closest('.item-row').remove();

    reindexarItens();
    atualizarTotalGeral();
    bloquearProdutosRepetidos();
    }

    // ==============================
    // INICIALIZAÇÃO
    // ==============================
            function inicializarEdicaoVenda() {

        // Para cada item carregado, atualiza tudo
        document.querySelectorAll('.item-row').forEach(row => {
            const select = row.querySelector(".select-produto");
            if (select && select.value !== "") {
                atualizarValor(select); // mostra estoque, valor unitário, total item
            }
        });

        atualizarTotalGeral();
        bloquearProdutosRepetidos();
    }

       function editarVenda(id) {
        $.get('/Venda/Editar/' + id, function (html) {
            $("#vendaEditarBody").html(html);

            // Agora funciona, porque a função está GLOBAL
            setTimeout(() => inicializarEdicaoVenda(), 0);
        });

        $("#modalEditar").modal("show");
    }

</script>